rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
   match /users/{userUid} {
   	allow read: if isLoggedIn();
    allow write: if isAdmin();
    allow update: if doesntChangeRoles();
   }
   
   match /projects/{projectId} {
   		allow read, update: if isAssignedToUser() || isAdmin();
      allow write: if isOwner() || isAdmin();
   }
    
    
    function isLoggedIn() {
    	return request.auth.uid != null;
    }
    
    function doesntChangeRoles() {
    	return !request.resource.data.keys().hasAny(["roles"]);    
    }
      
    function isAssignedToUser() {
			return request.auth.uid in resource.data.assignedUsers;
		}
    
    function isOwner() {
			return request.auth.uid == resource.id;
		}
    
    function isAdmin(){
    	return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin;
    }
  }
}